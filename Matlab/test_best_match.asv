
% Written by Amy on 08/21/2025
% Rewritten by Amy on 08/26/2025 to test the best_match(..) and best_match
% template(..)
% Modified by Amy on 08/28/2025 for clarity
% add 'template' as a variable by Amy on 08/31/2025
% Line up the variables names with the paper by Amy on 08/31/2025

clear; % clear the memory

cat_folder = '/Users/lanheng/Desktop/image_similarity_2025/image_similarity/synthetic_data/cat_image';
N = 301;                       % number of images
m = 50; n = 50;                % size of images
topJ = 16;                     % top J images 
query_idx = 1;                 % use cat_001 as query image W

Template = randn(50,50,50);    % define the size of the template bank m*n*K          

% FUTURE: uncomment to use other templates
% T = your_loaded_templates;      % m*n*K 
% K = size(image_collection,3);  % template count: K total

% load stack M*N*J and the query img
image_collection = zeros(m,n,N);
for j = 1:N
    S = load(fullfile(cat_folder, sprintf('cat_%03d.mat', j)));
    image_collection(:,:,j) = S.A;         % each mat file has 50 * 50 variable A 
end
query_image = image_collection(:,:,query_idx);

% run both methods
out_fft = best_match(image_collection, query_image, topJ);
out_tpl = best_match_template(image_collection, query_image, topJ,template);

% print all the outputs
fprintf('\n=== FFT baseline ===\n');
fprintf('TopK idx: '); disp(out_fft.idx_topK);
fprintf('Shifts (row,col):\n'); disp(out_fft.shifts_topK);
fprintf('Elapsed: %.3f s\n', out_fft.t_total);

fprintf('\n=== Template method ===\n');
fprintf('TopK idx: '); disp(out_tpl.idx_topK);
fprintf('Shifts (row,col):\n'); disp(out_tpl.shifts_topK);

% overlap and simple comparison
overlap = intersect(out_fft.idx_topK, out_tpl.idx_topK);
fprintf('\nOverlap count (indices appearing in both Top-%d): %d\n', topJ, numel(overlap));
fprintf('Overlap indices: '); disp(sort(overlap));

% simple figure to visualize both rankings
figure('Name','TopK by FFT (top) vs Template (bottom)'); colormap gray
rows = 2; cols = topJ;
for k = 1:topJ
    j = out_fft.idx_topK(k);
    subplot(rows, cols, k); imagesc(image_collection(:,:,j)); axis image off
    title(sprintf('FFT %03d', j));

    j2 = out_tpl.idx_topK(k);
    subplot(rows, cols, k+topJ); imagesc(image_collection(:,:,j2)); axis image off
    title(sprintf('TPL %03d', j2));
end
